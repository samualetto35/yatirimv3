rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() { 
      return request.auth != null; 
    }
    
    function isVerified() { 
      return request.auth != null && request.auth.token.email_verified == true; 
    }
    
    function isAdmin() { 
      return isSignedIn() && exists(/databases/$(database)/documents/adminUsers/$(request.auth.uid)); 
    }

    // Users
    match /users/{userId} {
      allow read: if isVerified();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && request.auth.uid == userId && isVerified();
      allow delete: if false;
    }

    // Weeks
    match /weeks/{weekId} {
      allow read: if isVerified();
      allow write: if false;
    }

    // Market data
    match /marketData/{weekId} {
      allow read: if isVerified();
      allow write: if false;
    }

    // Market corrections
    match /marketCorrections/{weekId} {
      allow read: if isVerified();
      allow write: if false;
    }

    // Allocations (client creates/updates own)
    match /allocations/{docId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow create, update: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow delete: if false;
    }

    // Balances: allow read to any verified user (needed for overall leaderboard)
    match /balances/{userId} {
      allow read: if isVerified();
      allow write: if false;
    }

    // Weekly balances: allow read to any verified user (needed for leaderboard)
    match /weeklyBalances/{docId} {
      allow read: if isVerified();
      allow write: if false;
    }

    // Admin users collection (users can read their own admin status)
    match /adminUsers/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow write: if false;
    }

    // Logs (readable by admins only; functions write)
    match /logs/{logId} {
      allow read: if isAdmin();
      allow write: if false;
    }

    // Announcements: verified users can read, admins can write/delete
    match /announcements/{id} {
      allow read: if isVerified();
      allow create, update, delete: if isAdmin();
    }

    // Announcement read receipts (per user)
    match /announcementReads/{docId} {
      allow read: if isSignedIn() && resource.data.uid == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.uid == request.auth.uid;
      allow update, delete: if false;
    }
  }
}
